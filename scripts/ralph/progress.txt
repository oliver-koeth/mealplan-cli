# Ralph Progress Log
## Codebase Patterns
- Canonical domain enums are defined in `src/mealplan/domain/enums.py`; import enum types from `mealplan.domain.enums` to avoid duplicated value definitions.
- Canonical meal sequencing lives in `src/mealplan/domain/model.py` as `CANONICAL_MEAL_ORDER`; downstream modules should import this constant instead of recreating ordered meal lists.
- Contract DTOs should subclass `BoundaryModel` at every nesting level so `extra="forbid"` applies recursively; use strict numeric types in DTO fields to prevent string-to-number coercion.
- For constrained mapping keys in DTO contracts, type keys with `Literal` unions (for example `dict[Literal["1","2","3","4","5"], StrictInt]`) so out-of-domain keys fail schema parsing automatically.
- Response DTOs with per-meal arrays should enforce canonical order at schema boundary (validator against `CANONICAL_MEAL_ORDER`) so serialized JSON stays deterministic.
- Keep DTO units metadata centralized in `src/mealplan/application/contracts.py` as `CONTRACT_UNITS_POLICY`; document legacy naming exceptions there and mirror them in `docs/ARCHITECTURE.md`.

Started: Fri Feb 27 16:44:58 CET 2026
---
## 2026-02-27 16:47:53 CET - US-002
Codex output: /Users/Oliver.Koeth/work/mealplan-cli/scripts/ralph/.codex-last-message-iter-7.txt
- Implemented canonical shared meal ordering constant `CANONICAL_MEAL_ORDER` in the domain model module and exported it via `mealplan.domain`.
- Added unit tests validating canonical meal order exact sequence, uniqueness, and fixed six-meal count.
- Files changed: AGENT.md, src/mealplan/domain/model.py, src/mealplan/domain/__init__.py, tests/unit/test_domain_enums.py, scripts/ralph/prd.json, scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
  - Keep ordering contracts in `mealplan.domain.model` and reuse the tuple in response assembly/allocators to preserve deterministic output ordering.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
  - `US-002` required both package export and explicit test assertions (order + uniqueness + count), not only constant declaration.
  - Useful context (e.g., "the evaluation panel is in component X")
  - `make quality` remains the mandatory local gate (`ruff`, strict `mypy`, and `pytest`) before updating PRD status.
---
## 2026-02-27 16:46:07 CET - US-001
Codex output: /Users/Oliver.Koeth/work/mealplan-cli/scripts/ralph/.codex-last-message-iter-1.txt
- Implemented canonical `StrEnum` types for `Gender`, `ActivityLevel`, `CarbMode`, `TrainingLoadTomorrow`, and `MealName` in a single domain module and re-exported them from `mealplan.domain`.
- Added contract tests to verify exact enum values, successful parsing of valid payloads, and rejection of unknown enum values.
- Files changed: src/mealplan/domain/enums.py, src/mealplan/domain/__init__.py, tests/unit/test_domain_enums.py, scripts/ralph/prd.json, scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
  - Canonical value-set contracts should be enforced through Pydantic parsing tests, not only enum member assertions.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
  - The repository has `AGENT.md` (singular) at root rather than `AGENTS.md`; read it as the local agent instruction source.
  - Useful context (e.g., "the evaluation panel is in component X")
  - `make quality` is the required local gate and runs `ruff`, strict `mypy`, and `pytest`.
---
## 2026-02-27 16:49:35 CET - US-003
Codex output: /Users/Oliver.Koeth/work/mealplan-cli/scripts/ralph/.codex-last-message-iter-2.txt
- Implemented canonical request DTOs `MealPlanRequest` and nested `TrainingSession` in `src/mealplan/application/contracts.py` with exact Phase 2 field names and enum-backed dimensions.
- Enforced strict schema boundary behavior: forbidden unknown fields at all levels and strict numeric typing for `age`, `weight_kg`, and `zones_minutes` values.
- Added contract tests for valid parsing, root/nested unknown-field rejection, and numeric-string rejection while preserving existing probe contract coverage.
- Files changed: AGENT.md, src/mealplan/application/contracts.py, tests/unit/test_application_contracts.py, scripts/ralph/prd.json, scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
  - Keep request contract strictness in the DTO layer itself (`BoundaryModel` + strict field types) instead of adding ad-hoc checks in CLI/application services.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
  - To enforce unknown-field rejection in nested payloads, nested DTOs must inherit `BoundaryModel`; root-level `extra="forbid"` is not enough.
  - Useful context (e.g., "the evaluation panel is in component X")
  - `US-003` intentionally stops at schema-level validation; semantic/business-rule validation belongs to later stories/phases.
---
## 2026-02-27 16:51:22 CET - US-004
Codex output: /Users/Oliver.Koeth/work/mealplan-cli/scripts/ralph/.codex-last-message-iter-3.txt
- Implemented the training-zones contract with restricted `zones_minutes` keys (`"1"`..`"5"`), strict integer minute values, optional `training_session`, and optional `training_before_meal` at schema level.
- Added contract tests for optional training session/training_before_meal parsing and negative validation cases for invalid zone keys and non-integer minute types.
- Files changed: AGENT.md, src/mealplan/application/contracts.py, tests/unit/test_application_contracts.py, scripts/ralph/prd.json, scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
  - `Literal`-typed dict keys are the cleanest way in this codebase to enforce finite allowed mapping keys directly in DTO schema validation.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
  - Keep `training_before_meal` optional in Phase 2 contracts even when zone minutes are present; required-if-minutes>0 belongs to Phase 3 semantic validation.
  - Useful context (e.g., "the evaluation panel is in component X")
  - `make quality` should be re-run after any contract test additions to validate strict typing assumptions under `mypy --strict`.
---
## 2026-02-27 16:53:44 CET - US-005
Codex output: /Users/Oliver.Koeth/work/mealplan-cli/scripts/ralph/.codex-last-message-iter-4.txt
- Implemented canonical response contracts in `MealPlanResponse` and nested `MealAllocation` with exact required top-level and nested fields.
- Enforced canonical meal serialization order with a model-level validator against `CANONICAL_MEAL_ORDER`, and added a `MealPlanResponse.placeholder()` constructor for pre-calculation phases.
- Added response contract tests for exact key shape, canonical order rejection, deterministic JSON serialization, and placeholder instantiation.
- Files changed: AGENT.md, src/mealplan/application/contracts.py, tests/unit/test_application_contracts.py, scripts/ralph/prd.json, scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
  - Response boundary determinism is best enforced directly in DTO validation/serialization tests rather than in CLI glue code.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
  - `US-005` expects exact response keys including uppercase `TDEE`; renaming to `tdee` breaks the canonical contract.
  - Useful context (e.g., "the evaluation panel is in component X")
  - `MealPlanResponse.placeholder()` is now the intended way to instantiate full response shape before nutrition calculations are implemented.
---
## 2026-02-27 16:55:28 CET - US-006
Codex output: /Users/Oliver.Koeth/work/mealplan-cli/scripts/ralph/.codex-last-message-iter-5.txt
- Implemented explicit contract-level units policy as `CONTRACT_UNITS_POLICY` and added field-level documentation for `age` (years), `weight_kg` (kg), `zones_minutes` (minutes), and legacy `TDEE` semantics (kcal/day).
- Documented DTO naming policy and legacy `TDEE` compatibility in architecture docs to keep contract code and docs aligned.
- Added unit tests asserting published units policy metadata and contract field descriptions for age/TDEE.
- Files changed: AGENT.md, docs/ARCHITECTURE.md, src/mealplan/application/contracts.py, tests/unit/test_application_contracts.py, scripts/ralph/prd.json, scripts/ralph/progress.txt
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
  - Centralize cross-field contract metadata (like units) in the DTO module and test it directly so docs and schema boundaries stay synchronized.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
  - `TDEE` must remain uppercase for compatibility even though the units naming policy prefers suffixes like `*_kcal`.
  - Useful context (e.g., "the evaluation panel is in component X")
  - `make quality` catches both contract typing drift and documentation-adjacent regressions quickly for these Phase 2 stories.
---
